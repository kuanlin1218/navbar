<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <title>è©®æ ©é›²ç³»çµ±</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
  <script src="config.js"></script>
  <link rel="stylesheet" href="å…±ç”¨é¢¨æ ¼.css">
  <link id="dynamic-favicon" rel="icon" type="image/x-icon">

  <style>
    body {
        height: 100%;
        margin: 0;
        background-image: linear-gradient(120deg, #a1c4fd 0%, #c2e9fb 100%);
        background-repeat: no-repeat;
        background-attachment: fixed;
    }

    .input-group-text {
      color: rgb(12, 44, 228);
    }

    .btn-ç¶  {
      width:100%; /*å¯¬åº¦*/
      font-size:22px; /*æ–‡å­—å¤§å°*/
      padding:5px;
      letter-spacing: 8px; /*æ–‡å­—é–“è·*/
      font-weight:600; /*å­—é«”ç²—ç´°100-900*/ 
    }

    .custom-t {
      height: 45px;
    }
    .custom-c {
      background-color: none; 
      text-align: left; /*æ–‡å­—ç½®ä¸­*/
      appearance: none; /* ç§»é™¤ç€è¦½å™¨é è¨­æ¨£å¼ (é¸ç”¨) */
      font-size: 18px; 
      height: 45px;
    }

  </style>
</head>

<body>
  <!-- å°è¦½åˆ— -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
    <div class="container-fluid">
      <a class="navbar-brand" href="é¦–é .html">
        <img id="brandLogo" alt="Logo" class="navbar-logo">
        è©®æ ©CNCé›²ç«¯ç³»çµ±
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
        aria-controls="navbarNav" aria-expanded="false" aria-label="åˆ‡æ›å°è¦½åˆ—">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item">
            <a class="nav-link" href="é¦–é .html">ğŸ  é¦–é </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="åˆ€å…·å…¥åº«.html">ğŸ›’ åˆ€å…·å…¥åº«</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="åˆ€å…·æŸ¥è©¢.html">ğŸ” åˆ€å…·æŸ¥è©¢</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="åŠ å·¥æ•¸é‡ç™»è¨˜.html">ğŸ“‹ åŠ å·¥æ•¸é‡ç™»è¨˜</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="åŠ å·¥æ•¸é‡æŸ¥è©¢.html">ğŸ‘¨ğŸ»â€ğŸ’» åŠ å·¥æ•¸é‡æŸ¥è©¢</a>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- ç¬¬1éƒ¨åˆ†--æ•¸é‡ç™»è¨˜ -->
  <div class="container">
    <form action="" id="stockForm">
      <h2> ğŸ›’ CNCåˆ€å…·å…¥åº« ğŸ›’ </h2>
      <hr>
      <!-- é¡åˆ¥ -->
      <div class="input-group my-3">
        <span class="input-group-text">é¡åˆ¥</span>
        <select name="category" id="category" class="form-select custom" required></select>
      </div>
      <!-- å“åè¦æ ¼ -->
      <div class="input-group my-3 position-relative">
        <span class="input-group-text">å“åè¦æ ¼</span>
        <input name="spec" id="specInput" class="form-control custom" autocomplete="off" required>
        <!-- è‡ªå‹•å®Œæˆæç¤º -->
        <ul id="specSuggestions" class="list-group position-absolute w-100 z-3"
        style="top:100%; display:none; max-height:200px; overflow-y:auto;"></ul>
      </div>
      <!-- å» ç‰Œ -->
      <div class="input-group my-3">
        <span class="input-group-text">å» ç‰Œ</span>
        <input list="brandList" id="brand" name="brand" class="form-control custom" required>
        <datalist id="brandList"></datalist>
      </div>
      <!-- å» å•† -->
      <div class="input-group my-3">
        <span class="input-group-text">å» å•†</span>
        <input list="vendorList" id="vendor" name="vendor" class="form-control custom" required>
        <datalist id="vendorList"></datalist>
      </div>
      <!-- å–®åƒ¹ï¼Œæ•¸é‡ -->
      <div class="input-group my-3">
        <span class="input-group-text">å–®åƒ¹</span>
        <input type="number" inputmode="decimal" pattern="[0-9]*" name="unit_price" id="unit_price" class="form-control custom" required>
        <span class="input-group-text">æ•¸é‡</span>
        <input type="number" inputmode="decimal" pattern="[0-9]*" name="quantity" id="quantity" class="form-control custom" required>
      </div>
      <!-- ç¸½åƒ¹ -->
      <div class="input-group my-3">
        <span class="input-group-text">ç¸½åƒ¹</span>
        <input type="text" name="total_price" id="total_price" class="form-control custom" required readonly>
      </div>
      <!-- æ—¥æœŸ -->
      <div class="input-group my-3">
        <span class="input-group-text">æ—¥æœŸ</span>
        <input type="date" name="date" id="date" class="form-control custom" placeholder="YYYY/MM/DD" required>
      </div>
      <!-- å‚™è¨» -->
      <div class="input-group my-3">
        <span class="input-group-text custom-t">å‚™è¨»</span>
        <textarea class="form-control custom-c" name="note" id="note" rows="1"></textarea>
      </div>

      <!-- é€å‡ºä¸­æç¤º -->
      <div id="loading" class="text-center my-3" style="display: none;">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">é€å‡ºä¸­...</span>
        </div>
        <div>é€å‡ºä¸­ï¼Œè«‹ç¨å€™...</div>
      </div>
      
      <!-- é€å‡º -->
      <div class="row">
        <div class="col-sm-12">
          <button type="submit" id="submitButton" class="btn btn-ç¶  my-2">
            é€å‡º
          </button>
        </div>
      </div>
    </form>
    <hr>
    
    <!-- é¡¯ç¤ºè¡¨æ ¼å…§å®¹ -->
    <div class="table-container" id="result"></div>
    <br>
  </div>

  <script>
    // è¨­å®š LOGO åœ–ç‰‡ä¾†æº
    document.getElementById("brandLogo").src = LOGO_URL;
    // è¨­å®š favicon åœ–ç¤º
    document.getElementById("dynamic-favicon").href = FAVICON_URL;

    let allSpecs = [];

    window.onload = function () {
      setTodayDate();         // é è¨­ä»Šå¤©æ—¥æœŸ
      loadDropdownData();     // è¼‰å…¥ä¸‹æ‹‰é¸å–®ï¼ˆå«å“åï¼‰
    };

    function showLoading() {
        document.getElementById("loading").style.display = "block";
        document.getElementById("result").innerHTML = "";
    }

    function hideLoading() {
        document.getElementById("loading").style.display = "none";
    }

    function setTodayDate() {
      const today = new Date();
      const yyyy = today.getFullYear();
      const mm = String(today.getMonth() + 1).padStart(2, '0');
      const dd = String(today.getDate()).padStart(2, '0');
      document.getElementById('date').value = `${yyyy}-${mm}-${dd}`;
    }

    function loadDropdownData() {
      fetch(`${scriptUrl}?page=inventory`)
      .then(res => res.json())
      .then(data => {
        fillSelect('category', data.categories);
        fillDatalist("brandList", data.brands);
        fillDatalist("vendorList", data.vendors);
        allSpecs = data.specs || [];  // å„²å­˜å“åè¦æ ¼è³‡æ–™ï¼Œç”¨æ–¼è‡ªå‹•æç¤º
      })
      .catch(err => {
        console.error('è¼‰å…¥é¸å–®è³‡æ–™å¤±æ•—ï¼š', err);
        document.getElementById('result').innerHTML = `<p class="text-danger">è¼‰å…¥é¸å–®è³‡æ–™å¤±æ•—</p>`;
      });
    }

    function fillSelect(id, options) {
      const select = document.getElementById(id);
      select.innerHTML = ""; // æ¸…ç©ºåŸæœ‰å…§å®¹
      options.forEach(opt => {
        const option = document.createElement("option");
        option.value = opt;
        option.text = opt;
        select.appendChild(option);
      });
    }

    function fillDatalist(id, options) {
      const datalist = document.getElementById(id);
      datalist.innerHTML = ""; // æ¸…ç©º
      options.forEach(opt => {
        const option = document.createElement("option");
        option.value = opt;
        datalist.appendChild(option);
      });
    }

    document.getElementById('unit_price').addEventListener('input', updateTotalPrice);
    document.getElementById('quantity').addEventListener('input', updateTotalPrice);

    function updateTotalPrice() {
      const unitPrice = parseFloat(document.getElementById('unit_price').value);
      const quantity = parseFloat(document.getElementById('quantity').value);
      const total = (!isNaN(unitPrice) && !isNaN(quantity)) ? unitPrice * quantity : 0;
      document.getElementById('total_price').value = '$' + total.toFixed(0);
    }

    document.getElementById('stockForm').addEventListener('submit', e => {
      e.preventDefault();
      const formData = new FormData(e.target);
      const data = Object.fromEntries(formData.entries());
      // å°‡æ—¥æœŸæ ¼å¼è½‰æˆ yyyy/mm/dd
      if (data.date) {
        const d = new Date(data.date);
        data.date = `${d.getFullYear()}/${String(d.getMonth() + 1).padStart(2, '0')}/${String(d.getDate()).padStart(2, '0')}`;
      }
      showLoading();
      fetch(scriptUrl, {
        method: 'POST',
        body: JSON.stringify(data)
      })
      .then(res => res.json())
      .then(result => {
        hideLoading();
        if (result.success) {
          const stock = result.stock;
          const tableHtml = `
          <table class="table table-bordered mt-3">
          <thead class="table-dark">
          <tr>
          <th>ç·¨è™Ÿ</th>
          <th>é¡åˆ¥</th>
          <th>å“åè¦æ ¼</th>
          <th>å» ç‰Œ</th>
          <th>æ•¸é‡</th>
          </tr>
          </thead>
          <tbody>
          <tr>
          <td>${stock.ç·¨è™Ÿ}</td>
          <td>${stock.é¡åˆ¥}</td>
          <td>${stock["å“åè¦æ ¼"]}</td>
          <td>${stock.å» ç‰Œ}</td>
          <td>${stock.æ•¸é‡}</td>
          </tr>
          </tbody>
          </table>
          `;
          document.getElementById("result").innerHTML = tableHtml;
        }
      })
      .catch(err => {
        hideLoading();
        console.error("é€å‡ºå¤±æ•—ï¼š", err);
      });
    });

    document.addEventListener("DOMContentLoaded", () => {
      const specInput = document.getElementById("specInput");
      const suggestionBox = document.getElementById("specSuggestions");

      specInput.addEventListener("input", () => {
        const keyword = specInput.value.trim().toUpperCase();
        suggestionBox.innerHTML = "";

        if (!keyword) {
        suggestionBox.style.display = "none";
        return;
        }

        // éæ¿¾åŒ…å«é—œéµå­—çš„å“åï¼ˆæœ€å¤š10ç­†ï¼‰
        const matches = allSpecs.filter(spec =>
        spec.toUpperCase().includes(keyword)
        ).slice(0, 10);

        if (matches.length === 0) {
        suggestionBox.style.display = "none";
        return;
        }

        matches.forEach(spec => {
          const li = document.createElement("li");
          li.className = "list-group-item list-group-item-action";
          li.textContent = spec;
          li.onclick = () => {
            specInput.value = spec;
            suggestionBox.style.display = "none";
          };
          suggestionBox.appendChild(li);
        });

        suggestionBox.style.display = "block";
      });

      // é»æ“Šå…¶ä»–åœ°æ–¹æ”¶èµ·å»ºè­°æ¸…å–®
      document.addEventListener("click", e => {
        if (!suggestionBox.contains(e.target) && e.target !== specInput) {
          suggestionBox.style.display = "none";
        }
      });
    });

  </script>

</body>
</html>
