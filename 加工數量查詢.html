<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <title>è©®æ ©é›²ç³»çµ±</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script src="config.js"></script>
    <link rel="stylesheet" href="å…±ç”¨é¢¨æ ¼.css">
    <link id="dynamic-favicon" rel="icon" type="image/x-icon">

    <!-- âœ… XLSX + FileSaverï¼ˆä¸€å®šè¦åŠ ï¼‰ -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx-style@0.8.13/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>

    <style>
        body {
            height: 100%;
            margin: 0;
            background-image: linear-gradient(120deg, #f6d365 0%, #fda085 100%);
            background-repeat: no-repeat;
            background-attachment: fixed;
        }


        .input-group-text {
            color: rgb(11, 148, 4);
        }

        .btn-è— {
            width:100%;
            font-size:22px;
            padding:5px;
            height: 40px;
            font-weight: bold;
        }

        .btn-ç´« {
            width:100%;
            font-size:22px;
            padding:5px;
            height: 40px;
            font-weight: bold;
        }

        .btn-é»ƒ {
            width:100%;
            font-size:22px;
            padding:5px;
            height: 40px;
            font-weight: bold;
        }

        .btn-ç¶  {
            width:100%;
            font-size:22px;
            padding:5px;
            height: 40px;
            font-weight: bold;
        }

        /* ğŸ§® æœ€å¾Œä¸€åˆ—ï¼ˆç¸½è¨ˆåˆ—ï¼‰æ¨£å¼ */
        .footer-yellow td {
            font-weight: bold;         
            background-color: #ffe345; 
            font-size:18px;
        }

        .info-box {
            background-color: #478648;
            border: 1px solid #ccc;    /* æ·¡ç°é‚Šæ¡†ç·š */
            padding: 8px;
            white-space: nowrap;       /* é˜²æ­¢è‡ªå‹•æ›è¡Œï¼ˆè®“æ¬„ä½æ’é–‹ï¼‰ */
            text-align: center;        /* æ–‡å­—ç½®ä¸­ */
            height: 40px;
            font-size: 18px;
            color: white;              /* ç™½è‰²å­—é«” */
            font-weight: bold;         /* åŠ ç²—å­—é«” */
        }

    </style>
</head>

<body>
  <!-- å°è¦½åˆ— -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
    <div class="container-fluid">
      <a class="navbar-brand" href="é¦–é .html">
        <img id="brandLogo" alt="Logo" class="navbar-logo">
        è©®æ ©CNCé›²ç«¯ç³»çµ±
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
        aria-controls="navbarNav" aria-expanded="false" aria-label="åˆ‡æ›å°è¦½åˆ—">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto">
            <li class="nav-item">
                <a class="nav-link" href="é¦–é .html">ğŸ  é¦–é </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="åˆ€å…·å…¥åº«.html">ğŸ›’ åˆ€å…·å…¥åº«</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="åˆ€å…·æŸ¥è©¢.html">ğŸ” åˆ€å…·æŸ¥è©¢</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="åŠ å·¥æ•¸é‡ç™»è¨˜.html">ğŸ“‹ åŠ å·¥æ•¸é‡ç™»è¨˜</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="åŠ å·¥æ•¸é‡æŸ¥è©¢.html">ğŸ‘¨ğŸ»â€ğŸ’» åŠ å·¥æ•¸é‡æŸ¥è©¢</a>
            </li>
        </ul>
      </div>
    </div>
  </nav>

    <div class="container">
        <form id="myForm2" onsubmit="searchValues(event)">
            <h2 class="text-center">ğŸ‘¨ğŸ»â€ğŸ’» åŠ å·¥æ•¸é‡æŸ¥è©¢ ğŸ‘¨ğŸ»â€ğŸ’»</h2><hr>
            <div class="input-group my-3">
                <span class="input-group-text">é–‹å§‹æ—¥æœŸ</span>
                <input type="date" id="dt1" class="form-control custom" required>
            </div>
            <div class="input-group my-3">
                <span class="input-group-text">çµæŸæ—¥æœŸ</span>
                <input type="date" id="dt2" class="form-control custom" required>
            </div>
            <div class="input-group my-3">
                <span class="input-group-text">ç”¢å“ç·¨è™Ÿ</span>
                <select id="pd" class="form-select custom" required><option>è¼‰å…¥ä¸­...</option></select>
            </div>
            <div class="input-group my-3">
                <span class="input-group-text">è¨‚å–®ç·¨è™Ÿ</span>
                <select id="od" class="form-select custom" required><option>è¼‰å…¥ä¸­...</option></select>
            </div>
            <!-- æŸ¥è©¢ä¸­æç¤º -->
            <div id="loading" class="text-center my-3" style="display: none;">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">æŸ¥è©¢ä¸­...</span>
                </div>
                <div>æŸ¥è©¢ä¸­ï¼Œè«‹ç¨å€™...</div>
            </div>
            <div class="d-flex justify-content-center my-3">
                <button type="submit" class="btn btn-è— ms-2">æ—¥æœŸå€é–“æŸ¥è©¢</button>
                <button type="button" class="btn btn-ç´« ms-2" onclick="searchlastValues(event)">æŸ¥è©¢æœ€å¾Œä¸€ç­†</button>
            </div>
            <div class="d-flex justify-content-center my-3">
                <button type="button" class="btn btn-é»ƒ ms-2" onclick="loadData()">æŸ¥è©¢å…¨éƒ¨</button>
                <button type="button" class="btn btn-ç¶  ms-2" id="exportBtn" onclick="exportTable()" disabled>ä¸‹è¼‰ Excel</button>
            </div>

        </form>
        <hr>
        
        <!-- é¡¯ç¤ºè¡¨æ ¼å…§å®¹ -->
        <div class="table-container" id="result"></div>
        <br>
    </div>

    <script>
        // è¨­å®š LOGO åœ–ç‰‡ä¾†æº
        document.getElementById("brandLogo").src = LOGO_URL;
        // è¨­å®š favicon åœ–ç¤º
        document.getElementById("dynamic-favicon").href = FAVICON_URL;

        window.onload = function () {
            // é è¨­æ—¥æœŸ
            setYesterdayDate('dt1');
            setYesterdayDate('dt2');

            // ä¸€é–‹å§‹è¼‰å…¥æ‰€æœ‰ç”¢å“ï¼ˆpdï¼‰
            fetch(`${scriptUrl}?page=production_query&type=dropdown`)
                .then(res => res.json())
                .then(data => {
                    const pd = document.getElementById("pd");
                    const od = document.getElementById("od");

                    // å¡«å…¥ç”¢å“ä¸‹æ‹‰é¸å–®
                    pd.innerHTML = '<option value=""></option>';
                    data.products.forEach(p => {
                        pd.appendChild(new Option(p, p));
                    });

                    // è¨‚å–®å…ˆæ¸…ç©ºï¼Œæç¤ºé¸ç”¢å“
                    od.innerHTML = '<option value=""></option>';
                })
                .catch(err => alert("è¼‰å…¥ç”¢å“æ¸…å–®å¤±æ•—ï¼š" + err.message));

            // ç•¶ä½¿ç”¨è€…é¸æ“‡ç”¢å“å¾Œï¼Œè‡ªå‹•è¼‰å…¥è©²ç”¢å“çš„è¨‚å–®ç·¨è™Ÿ
            document.getElementById("pd").addEventListener("change", function () {
                const selectedProduct = this.value;
                const od = document.getElementById("od");

                if (!selectedProduct) {
                    od.innerHTML = '<option value=""></option>';
                    return;
                }

                fetch(`${scriptUrl}?page=production_entry&type=order&pd=${encodeURIComponent(selectedProduct)}`)
                    .then(res => res.json())
                    .then(orderList => {
                        od.innerHTML = orderList.map(o => `<option value="${o}">${o}</option>`).join('');
                    })
                    .catch(err => {
                        alert("è¼‰å…¥è¨‚å–®ç·¨è™Ÿå¤±æ•—ï¼š" + err.message);
                    });
            });
        };

            function setYesterdayDate(inputId) {
                const date = new Date();
                date.setDate(date.getDate() - 1);
                const yyyy = date.getFullYear();
                const mm = String(date.getMonth() + 1).padStart(2, '0');
                const dd = String(date.getDate()).padStart(2, '0');
                document.getElementById(inputId).value = `${yyyy}-${mm}-${dd}`;
            }

            function showLoading() {
                document.getElementById("loading").style.display = "block";
                document.getElementById("result").innerHTML = "";
            }

            function hideLoading() {
                document.getElementById("loading").style.display = "none";
            }

            //ä¾æ—¥æœŸå€é–“.ç”¢å“.è¨‚å–®æŸ¥æœ€å¾Œä¸€ç­†
            function searchValues(event) {
                event.preventDefault();
                document.getElementById("exportBtn").disabled = true;

                const dt1 = document.getElementById("dt1").value;
                const dt2 = document.getElementById("dt2").value;
                const pd = document.getElementById("pd").value;
                const od = document.getElementById("od").value;

                if (!pd) return alert("è«‹é¸æ“‡ç”¢å“ç·¨è™Ÿ");
                if (!od) return alert("è«‹è¼¸å…¥è¨‚å–®ç·¨è™Ÿ");

                const d1 = new Date(dt1);
                const d2 = new Date(dt2);
                const f1 = `${d1.getFullYear()}/${d1.getMonth() + 1}/${d1.getDate()}`;
                const f2 = `${d2.getFullYear()}/${d2.getMonth() + 1}/${d2.getDate()}`;

                showLoading();
                fetch(`${scriptUrl}?page=production_query&pd=${encodeURIComponent(pd)}&od=${encodeURIComponent(od)}&dt1=${f1}&dt2=${f2}`)
                    .then(res => res.json())
                    .then(rows => {
                    hideLoading();
                    displayTable(rows);
                    })
                    .catch(() => {
                    hideLoading();
                    alert("æŸ¥è©¢å¤±æ•—");
                    });
            }

            //ä¾ç”¢å“.è¨‚å–®æŸ¥æœ€å¾Œä¸€ç­†
            function searchlastValues(event) {
                event.preventDefault();
                document.getElementById("exportBtn").disabled = true;

                const pd = document.getElementById("pd").value;
                const od = document.getElementById("od").value;

                if (!pd || !od) return alert("è«‹é¸æ“‡ç”¢å“ç·¨è™Ÿèˆ‡è¨‚å–®ç·¨è™Ÿ");

                showLoading();

                fetch(`${scriptUrl}?page=production_query&mode=latest&pd=${encodeURIComponent(pd)}&od=${encodeURIComponent(od)}`)
                    .then(res => res.json())
                    .then(data => {
                    hideLoading();
                    displayTable(data);
                    })
                    .catch(() => {
                    hideLoading();
                    alert("æŸ¥è©¢å¤±æ•—");
                    });
            }

            function displayTable(data, emptyMessage = "æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„è³‡æ–™") {
                const resultDiv = document.getElementById("result");

                if (!data || data.length === 0) {
                    resultDiv.innerHTML = `<p>${emptyMessage}</p>`;
                    return;
                }

                const headers = ["æ—¥æœŸ", "ç”¢å“ç·¨è™Ÿ", "æ•¸é‡"];
                let html = `<table class="table table-bordered table-striped"><thead><tr>`;
                headers.forEach(h => {
                    html += `<th>${h}</th>`;
                });
                html += `</tr></thead><tbody>`;

                let total = 0;
                data.forEach(row => {
                    html += `<tr>`;
                    row.forEach((cell, i) => {
                        html += `<td>${cell}</td>`;
                        if (i === 2) total += parseInt(cell) || 0;
                    });
                    html += `</tr>`;
                });

                html += `<tr class="footer-yellow"><td colspan="2">ç¸½æ•¸é‡</td><td>${total}</td></tr>`;
                html += `</tbody></table>`;
                resultDiv.innerHTML = html;
            }

        document.querySelectorAll('.navbar-nav .nav-link').forEach(link => {
            link.addEventListener('click', () => {
                const navbar = document.getElementById('navbarNav');
                if (navbar.classList.contains('show')) navbar.classList.remove('show');
            });
        });

        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function (e) {
                e.preventDefault();
                const target = document.querySelector(this.getAttribute('href'));
                if (target) {
                    window.scrollTo({ top: target.offsetTop - 50, behavior: 'smooth' });
                }
            });
        });


        // åŒ¯å‡ºexcel////////////////////////////////////////////////////////////////////////////
        const dropdownUrl = `${scriptUrl}?page=production_query&type=dropdown`;
        const dataUrl = `${scriptUrl}?page=production_query&type=export_data`;

        function loadData() {
        const pd = document.getElementById('pd').value;
        const od = document.getElementById('od').value;
        const resultDiv = document.getElementById('result');

        showLoading();
        fetch(`${dataUrl}&pd=${encodeURIComponent(pd)}&od=${encodeURIComponent(od)}`)
            .then(res => res.json())
            .then(data => {
            if (data.length === 0) {
                resultDiv.innerHTML = "æŸ¥ç„¡è³‡æ–™";
                return;
            }

            let totalQty = 0;
            let totalMins = 0;
            let dateSet = new Set();

            let html = `
                <div class="info-box">
                ç”¢å“ç·¨è™Ÿï¼š${pd}ã€€ã€€è¨‚å–®ç·¨è™Ÿï¼š${od}
                </div>
                <table id="dataTable">
                <thead>
                    <tr>
                    <th>æ—¥æœŸ</th>
                    <th>æ©Ÿå°</th>
                    <th>æ™‚</th>
                    <th>åˆ†</th>
                    <th>æ•¸é‡</th>
                    <th>ç¸½æ™‚é–“</th>
                    <th>å‚™è¨»</th>
                    </tr>
                </thead>
                <tbody>
            `;

            data.forEach(row => {
                const date = row[0];
                const qty = parseInt(row[6]) || 0;
                const hr = parseInt(row[4]) || 0;
                const min = parseInt(row[5]) || 0;
                const totalThisMins = hr * 60 + min;

                totalQty += qty;
                totalMins += totalThisMins;
                dateSet.add(date);

                html += '<tr>';
                html += `<td>${row[0]}</td>`;
                html += `<td>${row[1]}</td>`;
                html += `<td>${row[4]}</td>`;
                html += `<td>${row[5]}</td>`;
                html += `<td>${row[6]}</td>`;
                html += `<td>${totalThisMins}</td>`;
                html += `<td>${row[7]}</td>`;
                html += '</tr>';
            });

            const totalDays = dateSet.size;
            const avgPerDay = totalDays > 0 ? Math.round(totalQty / totalDays) : 0;
            const avgPerPiece = totalQty > 0 ? Math.round((totalMins * 60) / totalQty) : 0;

            html += `
                </tbody>
                <tfoot>
                    <tr class="footer-yellow">
                    <td>åˆè¨ˆ</td>
                    <td>ç¸½å¤©æ•¸</td>
                    <td>ç¸½æ•¸é‡</td>
                    <td>ç¸½æ™‚é–“</td>
                    <td>1å¤©å¹³å‡(é¡†)</td>
                    <td>1é¡†å¹³å‡(s)</td>
                    <td></td>
                    </tr>
                    <tr class="footer-yellow">
                    <td></td>
                    <td>${totalDays}</td>
                    <td>${totalQty}</td>
                    <td>${totalMins}</td>
                    <td>${avgPerDay}</td>
                    <td>${avgPerPiece}</td>
                    <td></td>
                    </tr>
                </tfoot>
                </table>
            `;

            resultDiv.innerHTML = html;
            document.getElementById("exportBtn").disabled = false;
            hideLoading();
            })
            .catch(err => {
                hideLoading();
                resultDiv.innerHTML = "éŒ¯èª¤ï¼š" + err.message;
            });

            
        }

        function exportTable() {
        const pd = document.getElementById('pd').value;
        const od = document.getElementById('od').value;
        const table = document.getElementById('dataTable');
        const rows = table.querySelectorAll('tbody tr');
        const tfootRows = table.querySelectorAll('tfoot tr');

        const data = [];

        // è¡¨é ­
        data.push([`ç”¢å“ç·¨è™Ÿï¼š${pd}`, "", "", `è¨‚å–®ç·¨è™Ÿï¼š${od}`, "", "", ""]);
        data.push(["æ—¥æœŸ", "æ©Ÿå°", "æ™‚", "åˆ†", "æ•¸é‡", "ç¸½æ™‚é–“", "å‚™è¨»"]);

        // è³‡æ–™åˆ—
        rows.forEach(row => {
            const cells = row.querySelectorAll('td');
            const rowData = Array.from(cells).map(cell => cell.textContent.trim());
            data.push(rowData);
        });

        // çµ±è¨ˆåˆ—
        tfootRows.forEach(row => {
            const cells = row.querySelectorAll('td');
            const rowData = Array.from(cells).map(cell => cell.textContent.trim());
            data.push(rowData);
        });

        // âœ… æ”¹ç”¨ç´” JS è‡ªå»º Sheetï¼ˆä¸ä½¿ç”¨ utils.aoa_to_sheetï¼‰
        const ws = {};
        for (let r = 0; r < data.length; r++) {
            for (let c = 0; c < data[r].length; c++) {
            const cellAddress = XLSX.utils.encode_cell({ r, c });
            const cellValue = data[r][c];
            const cellStyle = {
                alignment: { horizontal: "center", vertical: "center" }
            };

            // âœ… è¡¨é ­ï¼šç¬¬ 0 åˆ—
            if (r === 0) {
                cellStyle.fill = {
                fgColor: { rgb: "EEEEEE" }
                };
                cellStyle.alignment.horizontal = "left"; // ç”¢å“/è¨‚å–®é å·¦
            }

            // âœ… æ¬„ä½æ¨™é¡Œåˆ—ï¼šç¬¬ 1 åˆ—
            if (r === 1) {
                cellStyle.fill = {
                fgColor: { rgb: "EEEEEE" }
                };
                cellStyle.font = { bold: true };
            }

            // âœ… è¡¨å°¾ï¼ˆå€’æ•¸ç¬¬2èˆ‡ç¬¬1åˆ—ï¼‰
            if (r >= data.length - 2) {
                cellStyle.fill = {
                fgColor: { rgb: "EEEEEE" }
                };
            }

            ws[cellAddress] = {
                v: cellValue,
                t: typeof cellValue === "number" ? "n" : "s",
                s: cellStyle
            };
            }
        }

        // ç¯„åœå®šç¾©
        ws["!ref"] = XLSX.utils.encode_range({
            s: { r: 0, c: 0 },
            e: { r: data.length - 1, c: data[0].length - 1 }
        });

        // åˆä½µå„²å­˜æ ¼ï¼ˆç”¢å“ç·¨è™Ÿã€è¨‚å–®ç·¨è™Ÿï¼‰
        ws["!merges"] = [
            { s: { r: 0, c: 0 }, e: { r: 0, c: 2 } }, // A1~C1
            { s: { r: 0, c: 3 }, e: { r: 0, c: 6 } }  // D1~G1
        ];

        // æ¬„å¯¬
        ws["!cols"] = [
            { wch: 12 }, { wch: 10 }, { wch: 10 }, { wch: 10 }, { wch: 10 }, { wch: 10 }, { wch: 20 }
        ];

        // è¨­å®šæ‰€æœ‰åˆ—çš„åˆ—é«˜
        ws["!rows"] = Array.from({ length: data.length }, (_, i) => {
            if (i === 0) return { hpt: 24 }; // è¡¨é ­ï¼šç”¢å“/è¨‚å–®ç·¨è™Ÿ
            if (i === 1) return { hpt: 18 }; // æ¬„ä½æ¨™é¡Œ
            if (i >= data.length - 2) return { hpt: 22 }; // è¡¨å°¾çµ±è¨ˆ
            return { hpt: 20 }; // å…¶é¤˜è³‡æ–™åˆ—
        });

        // å»ºç«‹å·¥ä½œç°¿
        const wb = {
            SheetNames: ["åŠ å·¥æ•¸é‡"],
            Sheets: {
            "åŠ å·¥æ•¸é‡": ws
            }
        };

        // åŒ¯å‡ºæª”æ¡ˆ
        const wbout = XLSX.write(wb, { bookType: 'xlsx', bookSST: false, type: 'binary' });

        function s2ab(s) {
            const buf = new ArrayBuffer(s.length);
            const view = new Uint8Array(buf);
            for (let i = 0; i < s.length; i++) view[i] = s.charCodeAt(i) & 0xFF;
            return buf;
        }

        saveAs(
            new Blob([s2ab(wbout)], { type: "application/octet-stream" }),
            `${pd}_åŠ å·¥æ•¸é‡æŸ¥è©¢.xlsx`
        );
    }
    </script>
</body>
</html>